# Operating system (build VM template)
# os: Windows Server 2012
image: Visual Studio 2017

# scripts that are called at very beginning, before repo cloning
init:
 - git config --global core.autocrlf true

 before_build:


# scripts that run after cloning repository
install:
 # Download install script to install .NET cli in .dotnet dir
 #- ps: mkdir -Force ".\scripts\obtain\" | Out-Null
 #- ps: Invoke-WebRequest "https://raw.githubusercontent.com/dotnet/cli/rel/1.0.0/scripts/obtain/install.ps1" -OutFile ".\scripts\obtain\install.ps1"
 #- ps: $env:DOTNET_INSTALL_DIR = "$pwd\.dotnetcli"
 #- ps: '& .\scripts\obtain\install.ps1 -Channel "preview" -version "$env:CLI_VERSION" -InstallDir "$env:DOTNET_INSTALL_DIR" -NoPath'
 # add dotnet to PATH
 #- ps: $env:Path = "$env:DOTNET_INSTALL_DIR;$env:Path"
 #- ps: $env:DNX_BUILD_VERSION = $env:APPVEYOR_BUILD_NUMBER
 - ps: $sha = "$env:APPVEYOR_REPO_COMMIT".substring(0,7)
 - ps: $env:MY_BUILD_TAG = "$env:APPVEYOR_BUILD_NUMBER.$env:APPVEYOR_REPO_BRANCH.$sha"
 - ps: $json = Get-Content .\src\project.json -Raw | ConvertFrom-Json
 - ps: $version = $json.version -replace "\*", $env:MY_BUILD_TAG
 - ps: Update-AppveyorBuild -Version $version
# - ps: Update-AppveyorBuild -Version "$version+$env:MY_BUILD_TAG"

# scripts to run before build
before_build:
# Restore NuGet
 - nuget restore
# Display .NET Core version
 - cmd: dotnet --version
# Display minimal restore text
 - cmd: dotnet restore ./src/src.csproj --verbosity m
# - npm cache clean
# - ps: npm install gulp bower
# - npm install -g gulp bower

# to run your custom scripts instead of automatic MSBuild
build_script:
# output will be in ./src/bin/debug/netcoreapp1.1/publish
 - cmd: dotnet publish ./src/src.csproj

# to run your custom scripts instead of automatic tests
#test_script:
# - ps: dnx -p .\test test

artifacts:
 - path: '\src\bin\Debug\netcoreapp2.0\publish'
   name: AppOutput

clone_depth: 1

deploy:
 - provider: Environment
   name: Demo
   website_name: aspnet5rc3
   on:
    appveyor_repo_tag: true

 - provider: Environment
   name: Test
   website_name: aspnet5rc2
   remove_files: true
#    on:
#     APPVEYOR_PULL_REQUEST_NUMBER: /\d+/
#   on:
#    branch: master

notifications:
 - provider: Slack
   incoming_webhook: https://hooks.slack.com/services/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
   channel: general
   on_build_success: true
   on_build_failure: true
   on_build_status_changed: true
 - provider: GitHubPullRequest
   on_build_success: true
   on_build_failure: true
   on_build_status_changed: true
